#!/usr/bin/env python3
from skyfield.api import load, Topos, utc
from skyfield import almanac
from datetime import datetime, timedelta
from argparse import ArgumentParser
from fractions import Fraction
import time
import os
from pathlib import Path
# from tempfile import TemporaryDirectory
import logging


logger = logging.getLogger('HeraclesXI')
logger.setLevel(logging.INFO)
ch = logging.StreamHandler()
stream_formatter = logging.Formatter('%(asctime)s - %(name)s [%(lineno)3d] - %(levelname)s: %(message)s')
ch.setFormatter(stream_formatter)
logger.addHandler(ch)
logger.info('started')

ap = ArgumentParser()
ap.add_argument('--target', choices=['sunrise', 'sunset'], default='sunset')
ap.add_argument('--destdir', type=str, default='/tmp', help='destination directory')
ap.add_argument('--minutes_before', type=float, default=4*60, help='minutes before target')
ap.add_argument('--minutes_after', type=float, default=18*4, help='minutes after target')
ap.add_argument('--seconds_between', type=int, default=60, help='seconds between captures')
ap.add_argument('--fps', type=int, default=30, help='frames per second')
args = ap.parse_args()
logger.info(args.__dict__)

try:
    import cv2
    logger.info('using opencv')
    def capture(to_path):
        cap = cv2.VideoCapture(0)
        leido, frame = cap.read()
        if leido:
            cv2.imwrite(str(to_path), frame)
            logger.info('capture success: %s' % to_path.stem)
        else:
            logger.error('capture failed: %s' % to_path.stem)
        cap.release()

except ImportError:
    from picamera import PiCamera, Color
    logger.info('using picamera')

    camera = PiCamera(resolution=(1280, 720))
    #   camera = PiCamera(resolution=(1280, 720), framerate=Fraction(2, 1))
    #   camera.iso = 100
    #   camera.shutter_speed = 500000 # camera.exposure_speed
    logger.info(f'{camera.resolution}')
    logger.info(f'{camera.framerate}')
    logger.info(f'{camera.shutter_speed}')

    time.sleep(2)
    def capture(to_path):
        camera.annotate_background = Color('black')
        camera.annotate_text = '%s\nss: %d\niso: %d' % (to_path.stem, camera.shutter_speed, camera.iso)
        camera.capture(str(to_path))
        logger.info('capture success: %s' % to_path.stem)


TOPOS = {
        'pergamino': Topos('33.904 S', '60.570 W'),
        'almagro': Topos('34.606 S', '58.419 W'),
        }


ts = load.timescale()
eph = load('de421.bsp')

is_sun_up = almanac.sunrise_sunset(eph, TOPOS['pergamino'])

BEFORE = timedelta(minutes=args.minutes_before)
AFTER = timedelta(minutes=args.minutes_after)

def is_capture_timeframe(t):
    if args.target == 'sunset':
        return is_sun_up(ts.utc((t - AFTER))) and not is_sun_up(ts.utc((t + BEFORE)))
    elif args.target == 'sunrise':
        return is_sun_up(ts.utc((t + BEFORE))) and not is_sun_up(ts.utc((t - AFTER)))



FFMPEG_CMD = 'ffmpeg -nostdin -framerate {fps} -pattern_type glob -i \'{input_name_format}\' -c:v libx264 -r 20 -pix_fmt yuv420p {output_path}'

def make_timelapse(destdir):
    logger.info('making timelapse')
    cmd = FFMPEG_CMD.format(
                            fps=args.fps,
                            input_name_format=str(destdir.joinpath('*.png')),
                            output_path=str(destdir.joinpath('timelapse.mp4'))
                           )
    logger.info(cmd)
    os.system(cmd)


# This var also serves as a flag
destdir = None

while True:

    now = datetime.now(utc)

    if is_capture_timeframe(now):

        if not destdir:
            destdir = Path(args.destdir).joinpath(now.strftime('%Y.%m.%d_%H.%M.%S.%f'))
            destdir.mkdir()
            logger.info('destdir created: %r' % destdir)
    
        image_path = destdir.joinpath('%s.png' % now.strftime('%Y.%m.%d_%H.%M.%S.%f'))
        capture(image_path)

    elif destdir:
        make_timelapse(destdir)
        destdir = None

    logger.info('sleeping')
    time.sleep(args.seconds_between)
